<!DOCTYPE HTML>
<html>
<head>
    <title>popup</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="./js/jquery-3.6.0.min.js"></script>
    <script src="./js/rect-event.js"></script>
    <link rel="stylesheet" href="./css/canvas.css">
</head>

<body onselectstart="return false">
<div class="canvas-wrap" style="z-index:0">
    <img src="./img/invisible.png" id="cell-top" class="canvas-cell" style="z-index:5; -webkit-user-drag: none;"></img>
    <canvas id="canvas-draw" class="canvas-cell" style="z-index:4"></canvas>
    <canvas id="canvas-rect" class="canvas-cell" style="z-index:3"></canvas>
    <img id="img-light" class="canvas-cell" style="z-index:2"></img>
    <img id="img-image" class="canvas-cell" style="z-index:1"></img>
</div>

<script>
/**
 * 画像の大きさに合わせて画面サイズを変える
 * （親で画像を選択した際、画像サイズが変わることを考慮）
 */
function resizeWindow(width, height) {
    // canvas-wrap内のサイズをそろえる
	$.each($('.canvas-cell'), function(idx, elm) {
		elm.setAttribute("width", width);
		elm.setAttribute("height", height);
	});

    // 枠等考慮して大き目にresize
	window.resizeTo(Number(width) + 50, Number(height) + 50);
}

/**
 * ウィンドウ表示時にcanvas反映
 */
function initLoad() {
	const kbn = queryStrings["kbn"];
	const no = queryStrings["no"];

    // 親のcanvasを取得描画
    var parentCanvasImage = window.opener.getCanvas(kbn, no, true);
    var parentCanvasLight = window.opener.getCanvas(kbn, no, false);

    var imgImage = $('#img-image').get(0);
    var imgLight = $('#img-light').get(0);
    imgImage.src = parentCanvasImage.toDataURL();
    imgLight.src = parentCanvasLight.toDataURL();

    // ウィンドウサイズを画像サイズに合わせる
    imgImage.onload = function() {
        resizeWindow(imgImage.naturalWidth, imgImage.naturalHeight);
    }
}

/** key毎のURLパラメータ */
var queryStrings;
/**
 * URLパラメータをkey毎にqueryStringsに設定する
 */
function getQueryStrings() {
    if (1 < document.location.search.length) {
        // 最初の1文字 (?記号) を除いた文字列を取得する
        var query = document.location.search.substring(1);

        // クエリの区切り記号 (&) で文字列を配列に分割する
        var parameters = query.split('&');

        var result = new Object();
        for (var i = 0; i < parameters.length; i++) {
            // パラメータ名とパラメータ値に分割する
            var element = parameters[i].split('=');

            var paramName = decodeURIComponent(element[0]);
            var paramValue = decodeURIComponent(element[1]);

            // パラメータ名をキーとして連想配列に追加する
            result[paramName] = decodeURIComponent(paramValue);
        }
        return result;
    }
    return null;
}

$(function(){
    // URLパラメータを分解保持
	queryStrings = getQueryStrings();

	// 初期表示
	initLoad();
});
</script>
</body>
</html>
